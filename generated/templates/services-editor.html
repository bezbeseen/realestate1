<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services Page Editor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .service-editor-card { margin-bottom: 2rem; }
        textarea.form-control { height: 150px; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Services Page Editor</h1>
            <p class="lead">Edit the content of your service pages.</p>
        </div>
        
        <div id="editor-container">
            <!-- Service editors will be dynamically inserted here -->
        </div>

        <div id="loading-state" class="text-center">
            <p>Loading service pages...</p>
        </div>
        <div id="error-state" class="alert alert-danger" style="display: none;"></div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const editorContainer = document.getElementById('editor-container');
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');

    try {
        // Fetch the list of service files from the API
        const servicesRes = await fetch('/api/services');
        if (!servicesRes.ok) {
            throw new Error('Failed to load service files.');
        }
        const serviceFiles = await servicesRes.json();

        for (const fileName of serviceFiles) {
            const serviceName = fileName.replace('.html', '').replace(/-/g, ' ');
            const productCard = await createServiceEditor(serviceName, fileName);
            editorContainer.appendChild(productCard);
        }

        loadingState.style.display = 'none';

    } catch (error) {
        console.error('Editor initialization failed:', error);
        loadingState.style.display = 'none';
        errorState.textContent = `Error: ${error.message}`;
        errorState.style.display = 'block';
    }
});

async function createServiceEditor(serviceName, fileName) {
    const card = document.createElement('div');
    card.className = 'card service-editor-card';
    card.id = `editor-${fileName}`;
    card.dataset.fileName = fileName;

    // We will fetch the page content to populate the editor
    let description = '';
    let subServices = [];
    try {
        const res = await fetch(`/dist/services/${fileName}`);
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        description = doc.querySelector('.details_content p.mb_30').textContent;

        const subServiceElements = doc.querySelectorAll('.sub-services-list li');
        subServices = Array.from(subServiceElements).map(li => li.textContent);

    } catch (e) {
        console.error(`Could not fetch or parse ${fileName}`, e);
    }
    
    let subServicesHtml = '';
    if (subServices.length > 0) {
        subServices.forEach(ss => subServicesHtml += createSubServiceRow(ss));
    } else {
        subServicesHtml = createSubServiceRow(); // Start with one empty row
    }

    card.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0 text-capitalize">${serviceName}</h4>
            <span class="text-muted">${fileName}</span>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label">Service Description</label>
                <textarea class="form-control description">${description}</textarea>
            </div>
            <hr>
            <h5>Sub-services</h5>
            <div class="sub-services-container">
                ${subServicesHtml}
            </div>
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="addSubServiceRow(this)">Add Sub-service</button>
        </div>
        <div class="card-footer text-end">
            <button class="btn btn-primary" onclick="saveService('${fileName}')">Save Changes</button>
        </div>
    `;
    return card;
}

function createSubServiceRow(name = '') {
    return `
        <div class="input-group mb-2">
            <input type="text" class="form-control sub-service-name" placeholder="e.g., Logo Design" value="${name}">
            <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">Remove</button>
        </div>
    `;
}

function addSubServiceRow(button) {
    const container = button.previousElementSibling;
    container.insertAdjacentHTML('beforeend', createSubServiceRow());
}

async function saveService(fileName) {
    const editorCard = document.getElementById(`editor-${fileName}`);
    const description = editorCard.querySelector('.description').value;
    const subServiceInputs = editorCard.querySelectorAll('.sub-service-name');
    const subServices = Array.from(subServiceInputs).map(input => input.value).filter(name => name.trim() !== '');


    try {
        const response = await fetch('/api/save-service', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fileName, description, subServices })
        });

        if (response.ok) {
            alert('Service saved successfully!');
        } else {
            const errorText = await response.text();
            throw new Error(errorText || 'Failed to save service.');
        }
    } catch (error) {
        console.error('Failed to save service:', error);
        alert(`Error: ${error.message}`);
    }
}

</script>
</body>
</html> 